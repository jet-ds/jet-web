---
import { getCollection } from 'astro:content';
import BaseLayout from '../../components/layout/BaseLayout.astro';
import Container from '../../components/ui/Container.astro';
import WorkCard from '../../components/works/WorkCard.astro';
import { sortWorks } from '../../utils/sortByDate';

// Fetch all works
const allWorks = await getCollection('works');

// Sort works by date (newest first)
const sortedWorks = sortWorks(allWorks);

// Get the selected type from URL query params (optional filtering)
const url = Astro.url;
const selectedType = url.searchParams.get('type') as 'research' | 'project' | 'other' | null;

// Filter works by type if a type is selected
const displayedWorks = selectedType
  ? sortedWorks.filter(work => work.data.type === selectedType)
  : sortedWorks;

// Separate featured and non-featured works
const featuredWorks = displayedWorks.filter(work => work.data.featured);
const regularWorks = displayedWorks.filter(work => !work.data.featured);

// Count works by type
const workCounts = {
  all: allWorks.length,
  research: allWorks.filter(w => w.data.type === 'research').length,
  project: allWorks.filter(w => w.data.type === 'project').length,
  other: allWorks.filter(w => w.data.type === 'other').length,
};

const pageTitle = selectedType
  ? `Works - ${selectedType.charAt(0).toUpperCase() + selectedType.slice(1)}`
  : 'Works';
const pageDescription = selectedType
  ? `${selectedType === 'research' ? 'Research papers and publications' : selectedType === 'project' ? 'Projects and applications' : 'Other works'}`
  : 'Research papers, projects, and other professional work.';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <Container size="lg" class="py-12">
    {/* Header */}
    <div class="mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        {selectedType
          ? `${selectedType.charAt(0).toUpperCase() + selectedType.slice(1)} Works`
          : 'Works'}
      </h1>
      <p class="text-xl text-muted-foreground dark:text-muted-foreground-dark max-w-2xl">
        {pageDescription}
      </p>
    </div>

    {/* Type filter tabs */}
    <div class="mb-8 flex flex-wrap gap-2">
      <a
        href="/works"
        class={`px-4 py-2 rounded-lg transition-colors ${
          !selectedType
            ? 'bg-primary-600 text-white'
            : 'bg-card dark:bg-card-dark hover:bg-primary-100 dark:hover:bg-primary-900 text-foreground dark:text-foreground-dark'
        }`}
      >
        All ({workCounts.all})
      </a>
      <a
        href="/works?type=research"
        class={`px-4 py-2 rounded-lg transition-colors ${
          selectedType === 'research'
            ? 'bg-primary-600 text-white'
            : 'bg-card dark:bg-card-dark hover:bg-primary-100 dark:hover:bg-primary-900 text-foreground dark:text-foreground-dark'
        }`}
      >
        Research ({workCounts.research})
      </a>
      <a
        href="/works?type=project"
        class={`px-4 py-2 rounded-lg transition-colors ${
          selectedType === 'project'
            ? 'bg-primary-600 text-white'
            : 'bg-card dark:bg-card-dark hover:bg-primary-100 dark:hover:bg-primary-900 text-foreground dark:text-foreground-dark'
        }`}
      >
        Projects ({workCounts.project})
      </a>
      {workCounts.other > 0 && (
        <a
          href="/works?type=other"
          class={`px-4 py-2 rounded-lg transition-colors ${
            selectedType === 'other'
              ? 'bg-primary-600 text-white'
              : 'bg-card dark:bg-card-dark hover:bg-primary-100 dark:hover:bg-primary-900 text-foreground dark:text-foreground-dark'
          }`}
        >
          Other ({workCounts.other})
        </a>
      )}
    </div>

    {/* Works count */}
    <div class="mb-6 text-sm text-muted-foreground dark:text-muted-foreground-dark">
      {displayedWorks.length === 0 && (
        <p>No works found{selectedType ? ` in the ${selectedType} category` : ''}.</p>
      )}
      {displayedWorks.length === 1 && (
        <p>1 work{selectedType ? ` in the ${selectedType} category` : ''}</p>
      )}
      {displayedWorks.length > 1 && (
        <p>{displayedWorks.length} works{selectedType ? ` in the ${selectedType} category` : ''}</p>
      )}
    </div>

    {/* Featured works section */}
    {featuredWorks.length > 0 && (
      <div class="mb-12">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 dark:text-primary-400" viewBox="0 0 20 20" fill="currentColor">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
          </svg>
          Featured
        </h2>
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {featuredWorks.map((work) => (
            <WorkCard
              slug={work.slug}
              title={work.data.title}
              description={work.data.description}
              type={work.data.type}
              date={work.data.date}
              tags={work.data.tags}
              featured={work.data.featured}
              venue={work.data.venue}
              technologies={work.data.technologies}
              links={work.data.links}
            />
          ))}
        </div>
      </div>
    )}

    {/* Regular works grid */}
    {regularWorks.length > 0 && (
      <div>
        {featuredWorks.length > 0 && (
          <h2 class="text-2xl font-bold mb-6">
            {selectedType ? 'More Works' : 'All Works'}
          </h2>
        )}
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {regularWorks.map((work) => (
            <WorkCard
              slug={work.slug}
              title={work.data.title}
              description={work.data.description}
              type={work.data.type}
              date={work.data.date}
              tags={work.data.tags}
              featured={work.data.featured}
              venue={work.data.venue}
              technologies={work.data.technologies}
              links={work.data.links}
            />
          ))}
        </div>
      </div>
    )}

    {/* Empty state */}
    {displayedWorks.length === 0 && (
      <div class="text-center py-12">
        <p class="text-muted-foreground dark:text-muted-foreground-dark text-lg mb-4">
          {selectedType
            ? `No ${selectedType} works found.`
            : 'No works yet. Check back soon!'}
        </p>
        {selectedType && (
          <a
            href="/works"
            class="inline-block px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
          >
            View all works
          </a>
        )}
      </div>
    )}
  </Container>
</BaseLayout>
