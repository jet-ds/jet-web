---
import { formatDate } from '../../utils/formatDate';
import Tag from '../ui/Tag.astro';
import Card from '../ui/Card.astro';

interface Props {
  slug: string;
  title: string;
  description: string;
  type: 'research' | 'project' | 'other';
  date: Date;
  tags: string[];
  featured?: boolean;
  // For research papers
  venue?: string;
  // For projects
  technologies?: string[];
  // Links
  links?: { label: string; url: string }[];
}

const {
  slug,
  title,
  description,
  type,
  date,
  tags,
  featured,
  venue,
  technologies,
  links,
} = Astro.props;

const workUrl = `/works/${slug}`;
const formattedDate = formatDate(date);

// Type badge variants
const typeBadgeClass = {
  research: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300',
  project: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
  other: 'bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300',
};

const typeLabel = {
  research: 'Research',
  project: 'Project',
  other: 'Other',
};
---

<Card hover padding="lg" class="h-full flex flex-col">
  <a href={workUrl} class="block group flex-1 flex flex-col">
    {/* Header with type badge and featured indicator */}
    <div class="flex items-center justify-between mb-3">
      <span
        class={`inline-block px-3 py-1 rounded-full text-xs font-medium ${typeBadgeClass[type]}`}
      >
        {typeLabel[type]}
      </span>
      {featured && (
        <span class="text-primary-600 dark:text-primary-400 text-xs font-medium flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
          </svg>
          Featured
        </span>
      )}
    </div>

    {/* Title */}
    <h3 class="text-xl font-bold mb-2 text-foreground group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">
      {title}
    </h3>

    {/* Description */}
    <p class="text-muted mb-4 line-clamp-3 flex-1">
      {description}
    </p>

    {/* Type-specific metadata */}
    <div class="mb-4 space-y-2">
      {/* Research: Venue */}
      {type === 'research' && venue && (
        <div class="flex items-center gap-2 text-sm text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
          <span>{venue}</span>
        </div>
      )}

      {/* Project: Technologies */}
      {type === 'project' && technologies && technologies.length > 0 && (
        <div class="flex items-start gap-2 text-sm text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
          </svg>
          <span>{technologies.slice(0, 3).join(', ')}{technologies.length > 3 ? '...' : ''}</span>
        </div>
      )}

      {/* Date */}
      <div class="flex items-center gap-2 text-sm text-muted">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <time datetime={date.toISOString()}>{formattedDate}</time>
      </div>
    </div>

    {/* Tags */}
    {tags.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-4">
        {tags.slice(0, 4).map((tag) => (
          <Tag size="sm">{tag}</Tag>
        ))}
        {tags.length > 4 && (
          <span class="text-xs text-muted">+{tags.length - 4}</span>
        )}
      </div>
    )}
  </a>

  {/* Links (outside of main link to prevent nested links) */}
  {links && links.length > 0 && (
    <div class="flex flex-wrap gap-2 pt-4 border-t border-border">
      {links.map((link) => (
        <a
          href={link.url}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1 text-sm text-primary-600 dark:text-primary-400 hover:underline"
        >
          {link.label}
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        </a>
      ))}
    </div>
  )}
</Card>
